<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>File System Examples</title>
    <link rel="stylesheet" href="https://pyscript.net/alpha/pyscript.css" />
    <script defer src="https://pyscript.net/alpha/pyscript.js"></script>
  </head>
  <style>
      h1 {
       font-size: 20px;
       text-transform: uppercase;
       text-align: center;
       margin: 0 0 35px 0;
       text-shadow: 0px 1px 0px #f2f2f2;
         }

       </style>
  <body>
    <h1>Tool for fitting background noise of a flow cytometer</h1>

    <label for="myfile">Select an csv file containing your background noise:</label>
    <input type="file" id="myfile" name="myfile">
    <br />
    <br />
    <label for="bins_noise_input">Bins Noise Factor:</label>
    <input type="number" id="bins_noise_input" name="bins_noise_input" value="10"  style="background-color:DodgerBlue;">
    <br />
    <br />
    <div id="print_output"></div>
    <br />
    <p>Fittings results:</p>
      <div id="mean"></div>
      <div id="std"></div>

      <div id="lod"></div>
      <div id="graph-area"></div>
    <br/>
    <br/>
    <p>
        Steps taken
    </p>
    <ol>
        <li>1. Determine approximate mean, height, and standard deviation</li>
        <li>2. Fit gaussian function with approximate values as starting point</li>
        <li>3. Determine mean and standard deviation based on fit</li>
        <li>4. Calculate LoD: mean + 4*std</li>
    </ol>

    <py-env>
      - pandas
      - scipy
      - numpy
      - matplotlib
    </py-env>

    <py-script output="print_output">
    import asyncio
    from js import document, FileReader
    from pyodide import create_proxy
    import pandas as pd
    import io

    import numpy as np
    from scipy.optimize import curve_fit
    import matplotlib.pyplot as plt

    def gaussian(x, amplitude, mean, stddev):
        return amplitude * np.exp(-(x - mean)**2 / (2 * stddev**2))

    def fit(noise, factor=1):
        bins_noise = noise.max() - noise.min()
        bins, bin_edges = np.histogram(noise, bins=int(bins_noise / factor))

        initial_amplitude = np.max(bins)
        initial_std = np.std(noise)
        initial_mean = np.mean(noise)

        initial_guess = [initial_amplitude, initial_mean, initial_std]
        params, covariance = curve_fit(gaussian, bin_edges[:-1], bins, p0=initial_guess)

        amplitude_fit, mean_fit, stddev_fit = params

        return bins, bin_edges, amplitude_fit, mean_fit, stddev_fit

    async def process_file(event=None):
        fileList = document.getElementById("myfile").files.to_py()
        if not fileList:
            return

        bins_noise_factor = int(document.getElementById("bins_noise_input").value)

        for f in fileList:
            data = await f.text()
            df = pd.read_csv(io.StringIO(data))
            column_name = df.columns[0]
            noise = df[column_name]

            noise = noise[noise > 1]
            noise = noise[noise < 100000]

            bins, bin_edges, amplitude_fit, mean_fit, stddev_fit = fit(noise, factor=bins_noise_factor)
            y_fit = gaussian(bin_edges[:-1], amplitude_fit, mean_fit, stddev_fit)

            lod = mean_fit + (4 * stddev_fit)
            document.getElementById("mean").innerHTML = f"mean (a.u.): {mean_fit}"
            document.getElementById("std").innerHTML = f"std (a.u.): {stddev_fit}"

            document.getElementById("lod").innerHTML = f"LOD (a.u.): {lod}"

            plt.figure()
            plt.xlabel(column_name + " (a.u.)")
            plt.ylabel('Counts')
            plt.xlim(np.min(noise), mean_fit + (10 *stddev_fit))
            plt.plot(bin_edges[:-1], bins, label='Data')
            plt.plot(bin_edges[:-1], y_fit, label='Gaussian fit')
            plt.axvline(lod, c='red', linestyle='--', label='lod')
            plt.legend()

            from pyodide.http import pyfetch
            import js
            from io import BytesIO
            import base64

            buf = BytesIO()
            plt.savefig(buf, format='png')
            plt.close()
            buf.seek(0)

            img_str = base64.b64encode(buf.read()).decode("utf-8")
            img_element = document.createElement("img")
            img_element.src = "data:image/png;base64," + img_str
            document.getElementById("graph-area").innerHTML = ""
            document.getElementById("graph-area").appendChild(img_element)

    def main():
        file_event = create_proxy(process_file)
        bins_event = create_proxy(process_file)

        e = document.getElementById("myfile")
        e.addEventListener("change", file_event, False)

        bins_input = document.getElementById("bins_noise_input")
        bins_input.addEventListener("input", bins_event, False)

    main()
    </py-script>
  </body>
</html>
